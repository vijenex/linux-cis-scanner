{
  "milestone": "5.2.2",
  "title": "SSH Server Configuration - Part 2",
  "controls": [
    {
      "id": "5.2.2",
      "title": "Ensure sudo commands use pty",
      "automated": true,
      "profile": "Level1",
      "section": "5.2",
      "description": "\\\n\n\\f0\\b0 \\cf4 sudo\n\\f2 \\cf2  can be configured to run only from a pseudo terminal (\n\\f0 \\cf4 pseudo-pty\n\\f2 \\cf2 ).\\\n\n\\f1\\b",
      "rationale": "\\\n\n\\f2\\b0 Attackers can run a malicious program using \n\\f0 \\cf4 sudo\n\\f2 \\cf2  which would fork a background\\\nprocess that remains even when the main program has finished executing.\\\n\n\\f1\\b",
      "impact": "\\\nWARNING:\n\\f2\\b0  Editing the \n\\f0 \\cf4 sudo\n\\f2 \\cf2  configuration incorrectly can cause \n\\f0 \\cf4 sudo\n\\f2 \\cf2  to stop\\\nfunctioning. Always use \n\\f0 \\cf4 visudo\n\\f2 \\cf2  to modify \n\\f0 \\cf4 sudo\n\\f2 \\cf2  configuration files.\\\n\n\\f1\\b",
      "audit_command": "\\\n\n\\f2\\b0 Verify that \n\\f0 \\cf4 sudo\n\\f2 \\cf2  can only run other commands from a pseudo terminal.\\\nRun the following command to verify \n\\f0 \\cf4 Defaults use_pty\n\\f2 \\cf2  is set:\\\n\n\\f4\\fs20\\fsmilli10080 # grep -rPi --\\\n'^\\\\h*Defaults\\\\h+([^#\\\\n\\\\r]+,\\\\h*)?use_pty\\\\b' /etc/sudoers*\\\n\n\\f2\\fs24 Verify the output matches:\\\n\n\\f4\\fs20\\fsmilli10080 /etc/sudoers:Defaults use_pty\\\n\n\\f2\\fs24 Run the follow command to to verify \n\\f0 \\cf4 Defaults !use_pty\n\\f2 \\cf2  is not set:\\\n\n\\f4\\fs20\\fsmilli10080 # g",
      "remediation": "\\\n\n\\f2\\b0 Edit the file \n\\f0 \\cf4 /etc/sudoers\n\\f2 \\cf2  with \n\\f0 \\cf4 visudo\n\\f2 \\cf2  or a file in \n\\f0 \\cf4 /etc/sudoers.d/\n\\f2 \\cf2  with \n\\f0 \\cf4 visudo -f\\\n<PATH TO FILE>\n\\f2 \\cf2  and add the following line:\\\n\n\\f4\\fs20\\fsmilli10080",
      "references": "\\\n\n\\f2\\b0 1. SUDO(8)\\\n2. VISUDO(8)\\\n3. sudoers(5)\\\n4. NIST SP 800-53 Rev. 5: AC-6\\\n\n\\f1\\b",
      "type": "FileContent",
      "file_path": "/etc/sudoers*\\",
      "pattern": "",
      "expected_result": "found",
      "severity": "medium",
      "cis_reference": "CIS RHEL 8 v4.0.0 - 5.2.2 | Level1"
    },
    {
      "control_id": "5.2.9",
      "title": "Ensure SSH HostbasedAuthentication is disabled",
      "level": 1,
      "scored": true,
      "profile_applicability": "Level 1 - Server, Level 1 - Workstation",
      "description": "The HostbasedAuthentication parameter specifies if authentication is allowed through trusted hosts via the user of .rhosts, or /etc/hosts.equiv, along with successful public key client host authentication. This option only applies to SSH Protocol Version 2.",
      "rationale": "Even though the .rhosts files are ineffective if support is disabled in /etc/pam.conf, disabling the ability to use .rhosts files in SSH provides an additional layer of protection.",
      "audit": "Run the following command and verify that output matches:\n# sshd -T -C user=root -C host=\"$(hostname)\" -C addr=\"$(grep $(hostname) /etc/hosts | awk '{print $1}')\" | grep hostbasedauthentication\nhostbasedauthentication no",
      "remediation": "Edit the /etc/ssh/sshd_config file to set the parameter as follows:\nHostbasedAuthentication no",
      "impact": "None",
      "default_value": "HostbasedAuthentication no",
      "references": "1. See the sshd_config(5) man page for more information.",
      "cis_controls": "v8: 4.1 Establish and Maintain a Secure Configuration Process\nv7: 9.2 Ensure Only Approved Ports, Protocols and Services Are Running",
      "check_type": "Manual",
      "check_value": ""
    },
    {
      "control_id": "5.2.10",
      "title": "Ensure SSH root login is disabled",
      "level": 1,
      "scored": true,
      "profile_applicability": "Level 1 - Server, Level 1 - Workstation",
      "description": "The PermitRootLogin parameter specifies if the root user can log in using ssh. The default is no.",
      "rationale": "Disallowing root logins over SSH requires system admins to authenticate using their own individual account, then escalating to root via sudo or su. This in turn limits opportunity for non-repudiation and provides a clear audit trail in the event of a security incident.",
      "audit": "Run the following command and verify that output matches:\n# sshd -T -C user=root -C host=\"$(hostname)\" -C addr=\"$(grep $(hostname) /etc/hosts | awk '{print $1}')\" | grep permitrootlogin\npermitroot login no",
      "remediation": "Edit the /etc/ssh/sshd_config file to set the parameter as follows:\nPermitRootLogin no",
      "impact": "None",
      "default_value": "PermitRootLogin yes",
      "references": "1. See the sshd_config(5) man page for more information.",
      "cis_controls": "v8: 5.4 Restrict Administrator Privileges to Dedicated Administrator Accounts\nv7: 4.3 Ensure the Use of Dedicated Administrative Accounts",
      "check_type": "Manual",
      "check_value": ""
    },
    {
      "control_id": "5.2.11",
      "title": "Ensure SSH PermitEmptyPasswords is disabled",
      "level": 1,
      "scored": true,
      "profile_applicability": "Level 1 - Server, Level 1 - Workstation",
      "description": "The PermitEmptyPasswords parameter specifies if the SSH server allows login to accounts with empty password strings.",
      "rationale": "Disallowing remote shell access to accounts that have an empty password reduces the probability of unauthorized access to the system.",
      "audit": "Run the following command and verify that output matches:\n# sshd -T -C user=root -C host=\"$(hostname)\" -C addr=\"$(grep $(hostname) /etc/hosts | awk '{print $1}')\" | grep permitemptypasswords\npermitemptypasswords no",
      "remediation": "Edit the /etc/ssh/sshd_config file to set the parameter as follows:\nPermitEmptyPasswords no",
      "impact": "None",
      "default_value": "PermitEmptyPasswords no",
      "references": "1. See the sshd_config(5) man page for more information.",
      "cis_controls": "v8: 4.1 Establish and Maintain a Secure Configuration Process\nv7: 16.3 Require Multi-factor Authentication",
      "check_type": "Manual",
      "check_value": ""
    },
    {
      "control_id": "5.2.12",
      "title": "Ensure SSH PermitUserEnvironment is disabled",
      "level": 1,
      "scored": true,
      "profile_applicability": "Level 1 - Server, Level 1 - Workstation",
      "description": "The PermitUserEnvironment option allows users to present environment options to the ssh daemon.",
      "rationale": "Permitting users the ability to set environment variables through the SSH daemon could potentially allow users to bypass security controls (e.g. setting an execution path that has ssh executing trojan'd programs).",
      "audit": "Run the following command and verify that output matches:\n# sshd -T -C user=root -C host=\"$(hostname)\" -C addr=\"$(grep $(hostname) /etc/hosts | awk '{print $1}')\" | grep permituserenvironment\npermituserenvironment no",
      "remediation": "Edit the /etc/ssh/sshd_config file to set the parameter as follows:\nPermitUserEnvironment no",
      "impact": "None",
      "default_value": "PermitUserEnvironment no",
      "references": "1. See the sshd_config(5) man page for more information.",
      "cis_controls": "v8: 4.1 Establish and Maintain a Secure Configuration Process\nv7: 5.1 Establish Secure Configurations",
      "check_type": "Manual",
      "check_value": ""
    },
    {
      "control_id": "5.2.13",
      "title": "Ensure only strong Ciphers are used",
      "level": 1,
      "scored": true,
      "profile_applicability": "Level 1 - Server, Level 1 - Workstation",
      "description": "This variable limits the ciphers that SSH can use during communication.",
      "rationale": "Weak ciphers that are used for authentication to the cryptographic module cannot be relied upon to provide confidentiality or integrity, and system data may be compromised. The DES, Triple DES, and Blowfish ciphers, as used in SSH, have been demonstrated to have inherent weaknesses.",
      "audit": "Run the following command and verify that output does not contain any of the listed weak ciphers:\n# sshd -T -C user=root -C host=\"$(hostname)\" -C addr=\"$(grep $(hostname) /etc/hosts | awk '{print $1}')\" | grep ciphers\nVerify the returned ciphers do not include: 3des-cbc, aes128-cbc, aes192-cbc, aes256-cbc, arcfour, arcfour128, arcfour256, blowfish-cbc, cast128-cbc, rijndael-cbc@lysator.liu.se",
      "remediation": "Edit the /etc/ssh/sshd_config file add/modify the Ciphers line to contain a comma separated list of the site approved ciphers\nExample:\nCiphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr",
      "impact": "None",
      "default_value": "N/A",
      "references": "1. See the sshd_config(5) man page for more information.",
      "cis_controls": "v8: 3.10 Encrypt Sensitive Data in Transit\nv7: 14.4 Encrypt All Sensitive Information in Transit",
      "check_type": "Manual",
      "check_value": ""
    },
    {
      "control_id": "5.2.14",
      "title": "Ensure only strong MAC algorithms are used",
      "level": 1,
      "scored": true,
      "profile_applicability": "Level 1 - Server, Level 1 - Workstation",
      "description": "This variable limits the types of MAC algorithms that SSH can use during communication.",
      "rationale": "MD5 and 96-bit MAC algorithms are considered weak and have been shown to increase exploitability in SSH downgrade attacks. Weak algorithms continue to have a great deal of attention as a weak spot that can be exploited with expanded computing power. An attacker that breaks the algorithm could take advantage of a MiTM position to decrypt the SSH tunnel and capture credentials and information.",
      "audit": "Run the following command and verify that output does not contain any of the listed weak MAC algorithms:\n# sshd -T -C user=root -C host=\"$(hostname)\" -C addr=\"$(grep $(hostname) /etc/hosts | awk '{print $1}')\" | grep -i \"MACs\"\nVerify the returned MACs do not include: hmac-md5, hmac-md5-96, hmac-ripemd160, hmac-sha1, hmac-sha1-96, umac-64@openssh.com, umac-128@openssh.com, hmac-md5-etm@openssh.com, hmac-md5-96-etm@openssh.com, hmac-ripemd160-etm@openssh.com, hmac-sha1-etm@openssh.com, hmac-sha1-96-etm@openssh.com, umac-64-etm@openssh.com, umac-128-etm@openssh.com",
      "remediation": "Edit the /etc/ssh/sshd_config file and add/modify the MACs line to contain a comma separated list of the site approved MACs\nExample:\nMACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256",
      "impact": "None",
      "default_value": "N/A",
      "references": "1. See the sshd_config(5) man page for more information.",
      "cis_controls": "v8: 3.10 Encrypt Sensitive Data in Transit\nv7: 14.4 Encrypt All Sensitive Information in Transit",
      "check_type": "Manual",
      "check_value": ""
    },
    {
      "control_id": "5.2.15",
      "title": "Ensure only strong Key Exchange algorithms are used",
      "level": 1,
      "scored": true,
      "profile_applicability": "Level 1 - Server, Level 1 - Workstation",
      "description": "Key exchange is any method in cryptography by which cryptographic keys are exchanged between two parties, allowing use of a cryptographic algorithm. If the sender and receiver wish to exchange encrypted messages, each must be equipped to encrypt messages to be sent and decrypt messages received.",
      "rationale": "Key exchange methods that are considered weak should be removed. A key exchange method may be weak because too few bits are used, or the hashing algorithm is considered too weak. Using weak algorithms could expose connections to man-in-the-middle attacks.",
      "audit": "Run the following command and verify that output does not contain any of the listed weak Key Exchange algorithms:\n# sshd -T -C user=root -C host=\"$(hostname)\" -C addr=\"$(grep $(hostname) /etc/hosts | awk '{print $1}')\" | grep kexalgorithms\nVerify the returned algorithms do not include: diffie-hellman-group1-sha1, diffie-hellman-group14-sha1, diffie-hellman-group-exchange-sha1",
      "remediation": "Edit the /etc/ssh/sshd_config file add/modify the KexAlgorithms line to contain a comma separated list of the site approved key exchange algorithms\nExample:\nKexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group14-sha256,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,ecdh-sha2-nistp521,ecdh-sha2-nistp384,ecdh-sha2-nistp256,diffie-hellman-group-exchange-sha256",
      "impact": "None",
      "default_value": "N/A",
      "references": "1. See the sshd_config(5) man page for more information.",
      "cis_controls": "v8: 3.10 Encrypt Sensitive Data in Transit\nv7: 14.4 Encrypt All Sensitive Information in Transit",
      "check_type": "Manual",
      "check_value": ""
    },
    {
      "control_id": "5.2.16",
      "title": "Ensure SSH Idle Timeout Interval is configured",
      "level": 1,
      "scored": true,
      "profile_applicability": "Level 1 - Server, Level 1 - Workstation",
      "description": "The two options ClientAliveInterval and ClientAliveCountMax control the timeout of ssh sessions. When the ClientAliveInterval variable is set, ssh sessions that have no activity for the specified length of time are terminated. When the ClientAliveCountMax variable is set, sshd will send client alive messages at every ClientAliveInterval interval. When the number of consecutive client alive messages are sent with no response from the client, the ssh session is terminated. For example, if the ClientAliveInterval is set to 15 seconds and the ClientAliveCountMax is set to 3, the client ssh session will be terminated after 45 seconds of idle time.",
      "rationale": "Having no timeout value associated with a connection could allow an unauthorized user access to another user's ssh session (e.g. user walks away from their computer and doesn't lock the screen). Setting a timeout value at least reduces the risk of this happening. While the recommended setting is 300 seconds (5 minutes), set this timeout value based on site policy. The recommended setting for ClientAliveCountMax is 0. In this case, the client session will be terminated after 5 minutes of idle time and no keepalive messages will be sent.",
      "audit": "Run the following commands and verify ClientAliveInterval is between 1 and 300 and ClientAliveCountMax is 3 or less:\n# sshd -T -C user=root -C host=\"$(hostname)\" -C addr=\"$(grep $(hostname) /etc/hosts | awk '{print $1}')\" | grep clientaliveinterval\nclientaliveinterval 300\n# sshd -T -C user=root -C host=\"$(hostname)\" -C addr=\"$(grep $(hostname) /etc/hosts | awk '{print $1}')\" | grep clientalivecountmax\nclientalivecountmax 0",
      "remediation": "Edit the /etc/ssh/sshd_config file to set the parameters according to site policy:\nClientAliveInterval 300\nClientAliveCountMax 0",
      "impact": "None",
      "default_value": "ClientAliveInterval 0\nClientAliveCountMax 3",
      "references": "1. See the sshd_config(5) man page for more information.",
      "cis_controls": "v8: 4.3 Configure Automatic Session Locking on Enterprise Assets\nv7: 16.11 Lock Workstation Sessions After Inactivity",
      "check_type": "Manual",
      "check_value": ""
    },
    {
      "control_id": "5.2.17",
      "title": "Ensure SSH LoginGraceTime is set to one minute or less",
      "level": 1,
      "scored": true,
      "profile_applicability": "Level 1 - Server, Level 1 - Workstation",
      "description": "The LoginGraceTime parameter specifies the time allowed for successful authentication to the SSH server. The longer the Grace period is the more open unauthenticated connections can exist. Like other session controls in this session the Grace Period should be limited to appropriate organizational limits to ensure the service is available for needed access.",
      "rationale": "Setting the LoginGraceTime parameter to a low number will minimize the risk of successful brute force attacks to the SSH server. It will also limit the number of concurrent unauthenticated connections. While the recommended setting is 60 seconds (1 Minute), set the number based on site policy.",
      "audit": "Run the following command and verify that output LoginGraceTime is between 1 and 60:\n# sshd -T -C user=root -C host=\"$(hostname)\" -C addr=\"$(grep $(hostname) /etc/hosts | awk '{print $1}')\" | grep logingracetime\nlogingracetime 60",
      "remediation": "Edit the /etc/ssh/sshd_config file to set the parameter as follows:\nLoginGraceTime 60",
      "impact": "None",
      "default_value": "LoginGraceTime 120",
      "references": "1. See the sshd_config(5) man page for more information.",
      "cis_controls": "v8: 4.1 Establish and Maintain a Secure Configuration Process\nv7: 5.1 Establish Secure Configurations",
      "check_type": "Manual",
      "check_value": ""
    },
    {
      "control_id": "5.2.18",
      "title": "Ensure SSH warning banner is configured",
      "level": 1,
      "scored": true,
      "profile_applicability": "Level 1 - Server, Level 1 - Workstation",
      "description": "The Banner parameter specifies a file whose contents must be sent to the remote user before authentication is permitted. By default, no banner is displayed.",
      "rationale": "Banners are used to warn connecting users of the particular site's policy regarding connection. Presenting a warning message prior to the normal user login may assist the prosecution of trespassers on the computer system.",
      "audit": "Run the following command and verify that output matches:\n# sshd -T -C user=root -C host=\"$(hostname)\" -C addr=\"$(grep $(hostname) /etc/hosts | awk '{print $1}')\" | grep banner\nbanner /etc/issue.net",
      "remediation": "Edit the /etc/ssh/sshd_config file to set the parameter as follows:\nBanner /etc/issue.net",
      "impact": "None",
      "default_value": "Banner none",
      "references": "1. See the sshd_config(5) man page for more information.",
      "cis_controls": "v8: 4.1 Establish and Maintain a Secure Configuration Process\nv7: 5.1 Establish Secure Configurations",
      "check_type": "Manual",
      "check_value": ""
    },
    {
      "control_id": "5.2.19",
      "title": "Ensure SSH PAM is enabled",
      "level": 1,
      "scored": true,
      "profile_applicability": "Level 1 - Server, Level 1 - Workstation",
      "description": "UsePAM Enables the Pluggable Authentication Module interface. If set to 'yes' this will enable PAM authentication using ChallengeResponseAuthentication and PasswordAuthentication in addition to PAM account and session module processing for all authentication types.",
      "rationale": "When usePAM is set to yes, PAM runs through account and session types properly. This is important if you want to restrict access to services based off of IP, time or other factors of the account. Additionally, you can make sure users inherit certain environment variables on login or disallow access to the server.",
      "audit": "Run the following command and verify that output matches:\n# sshd -T -C user=root -C host=\"$(hostname)\" -C addr=\"$(grep $(hostname) /etc/hosts | awk '{print $1}')\" | grep -i usepam\nusepam yes",
      "remediation": "Edit the /etc/ssh/sshd_config file to set the parameter as follows:\nUsePAM yes",
      "impact": "None",
      "default_value": "UsePAM yes",
      "references": "1. See the sshd_config(5) man page for more information.",
      "cis_controls": "v8: 4.1 Establish and Maintain a Secure Configuration Process\nv7: 5.1 Establish Secure Configurations",
      "check_type": "Manual",
      "check_value": ""
    },
    {
      "control_id": "5.2.20",
      "title": "Ensure SSH AllowTcpForwarding is disabled",
      "level": 2,
      "scored": true,
      "profile_applicability": "Level 2 - Server, Level 2 - Workstation",
      "description": "SSH port forwarding is a mechanism in SSH for tunneling application ports from the client to the server, or servers to clients. It can be used for adding encryption to legacy applications, going through firewalls, and some system administrators and IT professionals use it for opening backdoors into the internal network from their home machines.",
      "rationale": "Leaving port forwarding enabled can expose the organization to security risks and back-doors. SSH connections are protected with strong encryption. This makes their contents invisible to most deployed network monitoring and traffic filtering solutions. This invisibility carries considerable risk potential if it is used for malicious purposes such as data exfiltration. Cybercriminals or malware could exploit SSH to hide their unauthorized communications, or to exfiltrate stolen data from the target network.",
      "audit": "Run the following command and verify that output matches:\n# sshd -T -C user=root -C host=\"$(hostname)\" -C addr=\"$(grep $(hostname) /etc/hosts | awk '{print $1}')\" | grep -i allowtcpforwarding\nallowtcpforwarding no",
      "remediation": "Edit the /etc/ssh/sshd_config file to set the parameter as follows:\nAllowTcpForwarding no",
      "impact": "SSH tunnels are widely used in many corporate environments that employ mainframe systems as their application backends. In those environments the applications themselves may have very limited native support for security. By utilizing tunneling, compliance with SOX, HIPAA, PCI-DSS, and other standards can be achieved without having to modify the applications.",
      "default_value": "AllowTcpForwarding yes",
      "references": "1. See the sshd_config(5) man page for more information.",
      "cis_controls": "v8: 4.8 Uninstall or Disable Unnecessary Services on Enterprise Assets and Software\nv7: 9.2 Ensure Only Approved Ports, Protocols and Services Are Running",
      "check_type": "Manual",
      "check_value": ""
    },
    {
      "control_id": "5.2.21",
      "title": "Ensure SSH MaxStartups is configured",
      "level": 1,
      "scored": true,
      "profile_applicability": "Level 1 - Server, Level 1 - Workstation",
      "description": "The MaxStartups parameter specifies the maximum number of concurrent unauthenticated connections to the SSH daemon.",
      "rationale": "To protect a system from denial of service due to a large number of pending authentication connection attempts, use the rate limiting function of MaxStartups to protect availability of sshd logins and prevent overwhelming the daemon.",
      "audit": "Run the following command and verify that output MaxStartups is 10:30:60 or more restrictive:\n# sshd -T -C user=root -C host=\"$(hostname)\" -C addr=\"$(grep $(hostname) /etc/hosts | awk '{print $1}')\" | grep -i maxstartups\nmaxstartups 10:30:60",
      "remediation": "Edit the /etc/ssh/sshd_config file to set the parameter as follows:\nMaxStartups 10:30:60",
      "impact": "None",
      "default_value": "MaxStartups 10:30:100",
      "references": "1. See the sshd_config(5) man page for more information.",
      "cis_controls": "v8: 4.1 Establish and Maintain a Secure Configuration Process\nv7: 5.1 Establish Secure Configurations",
      "check_type": "Manual",
      "check_value": ""
    },
    {
      "control_id": "5.2.22",
      "title": "Ensure SSH MaxSessions is set to 10 or less",
      "level": 1,
      "scored": true,
      "profile_applicability": "Level 1 - Server, Level 1 - Workstation",
      "description": "The MaxSessions parameter specifies the maximum number of open sessions permitted from a given connection.",
      "rationale": "To protect a system from denial of service due to a large number of concurrent sessions, use the rate limiting function of MaxSessions to protect availability of sshd logins and prevent overwhelming the daemon.",
      "audit": "Run the following command and verify that output MaxSessions is 10 or less:\n# sshd -T -C user=root -C host=\"$(hostname)\" -C addr=\"$(grep $(hostname) /etc/hosts | awk '{print $1}')\" | grep -i maxsessions\nmaxsessions 10",
      "remediation": "Edit the /etc/ssh/sshd_config file to set the parameter as follows:\nMaxSessions 10",
      "impact": "None",
      "default_value": "MaxSessions 10",
      "references": "1. See the sshd_config(5) man page for more information.",
      "cis_controls": "v8: 4.1 Establish and Maintain a Secure Configuration Process\nv7: 5.1 Establish Secure Configurations",
      "check_type": "Manual",
      "check_value": ""
    }
  ]
}