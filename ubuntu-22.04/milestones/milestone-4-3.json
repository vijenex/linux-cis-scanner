{
  "milestone": "4.3",
  "title": "Configure nftables",
  "description": "Configure nftables for host-based firewall protection",
  "controls": [
    {
      "id": "4.3.1",
      "title": "Ensure nftables is installed",
      "profile": "Level1",
      "type": "Package",
      "package": "nftables",
      "expected_state": "installed",
      "cis_reference": "https://www.cisecurity.org/benchmark/ubuntu_linux",
      "cis_control_id": "4.3.1",
      "description": "/etc/shells is a text file which contains the full pathnames of valid login shells. This file is consulted by chsh and available to be queried by other programs.\nBe aware that there are programs which consult this file to find out if a user is a normal user; for example, FTP daemons traditionally disallow access to users with shells not included in this file.",
      "remediation": "Edit /etc/shells and remove any lines that include nologin"
    },
    {
      "id": "4.3.2",
      "title": "Ensure ufw is uninstalled or disabled with nftables",
      "profile": "Level1",
      "type": "Manual",
      "cis_reference": "https://www.cisecurity.org/benchmark/ubuntu_linux",
      "cis_control_id": "4.3.2",
      "description": "TMOUT is an environmental setting that determines the timeout of a shell in seconds.\n• TMOUT= n - Sets the shell timeout to n seconds. A setting of TMOUT=0 disables timeout.\n• readonly TMOUT - Sets the TMOUT environmental variable as readonly, preventing unwanted modification during run -time.\n• export TMOUT - exports the TMOUT variable System Wide Shell Configuration Files:\n• /etc/profile - used to set system wide environmental variables on users shells. The variables are sometimes the same ones that are in the .bash_profile , however this file is used to set an initial PATH or PS1 for all shell users of the system. is only executed for interactive login shells, or shells executed with the --login parameter.\n• /etc/profile.d - /etc/profile will execute the scripts within /etc/profile.d/*.sh . It is recommended to place your configuration in a shell script within /etc/profile.d to set your own system wide environmental variables.\n• /etc/bash.bashrc - System wide version of .bashrc . In Fedora derived distributions, /etc/bashrc also invokes /etc/profile.d/*.sh if non-login shell, but redirects output to /dev/null if non-interactive. Is only executed for interactive shells or if BASH_ENV is set to /etc/bash.bashrc .",
      "remediation": "Review /etc/bashrc , /etc/profile , and all files ending in *.sh in the /etc/profile.d/ directory and remove or edit all TMOUT=_n_ entries to follow local site policy. TMOUT should not exceed 900 or be equal to 0.\nConfigure TMOUT in one of the following files:\n• A file in the /etc/profile.d/ directory ending in .sh • /etc/profile • /etc/bashrc Example command to set TMOUT to 900 seconds in a file in /etc/profile.d/ :\n# printf '%s ' \"# Set TMOUT to 900 seconds\" \"typeset -xr TMOUT=900\" > /etc/profile.d/50 -tmout.sh TMOUT configuration examples:\ntypeset -xr TMOUT=900 Deprecated methods:\n• As multiple lines:\nTMOUT=900 readonly TMOUT export TMOUT • As a single line:\nreadonly TMOUT=900 ; export TMOUT\nAdditional Information:\nThe audit and remediation in this recommendation apply to bash and shell. If other shells are supported on the system, it is recommended that their configuration files also are checked. Other methods of setting a timeout exist for other shells not covered here.\nEnsure that the timeout conforms to your local policy.\nInternal Only - General"
    },
    {
      "id": "4.3.3",
      "title": "Ensure iptables are flushed with nftables",
      "profile": "Level1",
      "type": "CommandOutputEmpty",
      "cis_reference": "https://www.cisecurity.org/benchmark/ubuntu_linux",
      "cis_control_id": "4.3.3",
      "description": "The user file -creation mode mask ( umask ) is used to determine the file permission for newly created directories and files. In Linux, the default permissions for any newly created directory is 0777 ( rwxrwxrwx ), and for any newly created file it is 0666 ( rw-rw- rw-). The umask modifies the default Linux permissions by restricting (masking) these permissions. The umask is not simply subtracted, but is processed bitwise. Bits set in the umask are cleared in the resulting file mode.\numask can be set with either Octal or Symbolic values:\n• Octal (Numeric) Value - Represented by either three or four digits. ie umask 0027 or umask 027 . If a four digit umask is used, the first digit is ignored. The remaining three digits effect the resulting permissions for user, group, and world/other respectively.\n• Symbolic Value - Represented by a comma separated list for User u, group g, and world/other o. The permissions listed are not masked by umask . ie a umask set by umask u=rwx,g=rx,o= is the Symbolic equivalent of the Octal umask 027. This umask would set a newly created directory with file mode drwxr-x--- and a newly created file with file mode rw-r----- .\nThe default umask can be set to use the pam_umask module or in a System Wide Shell Configuration File . The user creating the directories or files has the discretion of changing the permissions via the chmod command, or choosing a different default umask by adding the umask command into a User Shell Configuration File , ( .bash_profile or .bashrc ), in their home directory.\nSetting the default umask:\n• pam_umask module:\no will set the umask according to the system default in /etc/login.defs and user settings, solving the problem of different umask settings with different shells, display managers, remote sessions etc.\no umask=<mask> value in the /etc/login.defs file is interpreted as Octal o Setting USERGROUPS_ENAB to yes in /etc/login.defs (default):\n▪ will enable setting of the umask group bits to be the same as owner bits. (examples: 022 -> 002, 077 -> 007) for non -root users, if the uid is the same as gid, and username is the same as the <primary group name>  Internal Only - General ▪ userdel will remove the user's group if it contains no more members, and useradd will create by default a group with the name of the user • System Wide Shell Configuration File :\no /etc/profile - used to set system wide environmental variables on users shells. The variables are sometimes the same ones that are in the .bash_profile , however this file is used to set an initial PATH or PS1 for all shell users of the system. is only executed for interactive login shells, or shells executed with the --login parameter.\no /etc/profile.d - /etc/profile will execute the scripts within /etc/profile.d/*.sh . It is recommended to place your configuration in a shell script within /etc/profile.d to set your own system wide environmental variables.\no /etc/bashrc - System wide version of .bashrc . In Fedora derived distributions, etc/bashrc also invokes /etc/profile.d/*.sh if non-login shell, but redirects output to /dev/null if non-interactive. Is only executed for interactive shells or if BASH_ENV is set to /etc/bashrc .\nUser Shell Configuration Files:\n• ~/.bash_profile - Is executed to configure your shell before the initial command prompt. Is only read by login shells.\n• ~/.bashrc - Is executed for interactive shells. only read by a shell that's both interactive and non -login umask is set by order of precedence. If umask is set in multiple locations, this order of precedence will determine the system's default umask .\nOrder of precedence:\n1. A file in /etc/profile.d/ ending in .sh - This will override any other system - wide umask setting 2. In the file /etc/profile 3. On the pam_umask.so module in /etc/pam.d/postlogin 4. In the file /etc/login.defs 5. In the file /etc/default/login",
      "remediation": "1. Run the following script to comment out all occurrences of umask that are less restrictive than 027 in files ending in *.sh in the /etc/profile.d/ directory:\n#!/usr/bin/env bash while IFS= read -r -d $'\\0' l_file; do sed -ri '/^*umask+0?(0[01][0 -7]|0[0-7][^7]|[^0][0 -7][0- 7])(*|+.*)$/s/^/# /' \"$l_file\" done < <(find /etc/profile.d/ -type f -name '*.sh' -print0) 2. Create or edit a file in /etc/profile.d/ ending in *.sh and add or modify the following line:\numask 0027 Example:\n# printf '%s ' \"\" \"umask 027\" >> /etc/profile.d/60 -default_umask.sh 3. Edit /etc/login.defs and add or update the following line:\nUMASK 027 Notes:\n• This method only applies to bash and shell. If other shells are supported on the system, it is recommended that their configuration files also are checked • If the pam_umask.so module is going to be used to set umask , ensure that it's not being overridden by another setting. Refer to the PAM_UMASK(8) man page for more information Internal Only - General",
      "automated": true,
      "audit_command": "iptables -L -n | grep -v '^Chain' | grep -v '^target' | grep -v '^$' | grep -v '^\\s*$'"
    },
    {
      "id": "4.3.4",
      "title": "Ensure a nftables table exists",
      "profile": "Level1",
      "type": "ConfigFile",
      "file": "/etc/nftables.conf",
      "pattern": "table",
      "expected": "present",
      "cis_reference": "https://www.cisecurity.org/benchmark/ubuntu_linux",
      "cis_control_id": "4.3.4",
      "reference_note": "For detailed description, rationale, impact assessment, and remediation steps, please refer to the official CIS Ubuntu Linux 22.04 Benchmark document at the above URL."
    },
    {
      "id": "4.3.5",
      "title": "Ensure nftables base chains exist",
      "profile": "Level1",
      "type": "ConfigFile",
      "file": "/etc/nftables.conf",
      "pattern": "chain.*hook",
      "expected": "present",
      "cis_reference": "https://www.cisecurity.org/benchmark/ubuntu_linux",
      "cis_control_id": "4.3.5",
      "reference_note": "For detailed description, rationale, impact assessment, and remediation steps, please refer to the official CIS Ubuntu Linux 22.04 Benchmark document at the above URL."
    },
    {
      "id": "4.3.6",
      "title": "Ensure nftables loopback traffic is configured",
      "profile": "Level1",
      "type": "Manual",
      "cis_reference": "https://www.cisecurity.org/benchmark/ubuntu_linux",
      "cis_control_id": "4.3.6",
      "reference_note": "For detailed description, rationale, impact assessment, and remediation steps, please refer to the official CIS Ubuntu Linux 22.04 Benchmark document at the above URL."
    },
    {
      "id": "4.3.7",
      "title": "Ensure nftables outbound and established connections are configured",
      "profile": "Level1",
      "type": "CommandOutputEmpty",
      "cis_reference": "https://www.cisecurity.org/benchmark/ubuntu_linux",
      "cis_control_id": "4.3.7",
      "reference_note": "For detailed description, rationale, impact assessment, and remediation steps, please refer to the official CIS Ubuntu Linux 22.04 Benchmark document at the above URL.",
      "automated": true,
      "audit_command": "nft list ruleset | grep -E '(output|ct state established|ct state new)'"
    },
    {
      "id": "4.3.8",
      "title": "Ensure nftables default deny firewall policy",
      "profile": "Level1",
      "type": "Manual",
      "cis_reference": "https://www.cisecurity.org/benchmark/ubuntu_linux",
      "cis_control_id": "4.3.8",
      "reference_note": "For detailed description, rationale, impact assessment, and remediation steps, please refer to the official CIS Ubuntu Linux 22.04 Benchmark document at the above URL."
    },
    {
      "id": "4.3.9",
      "title": "Ensure nftables service is enabled",
      "profile": "Level1",
      "type": "Service",
      "service": "nftables",
      "expected_state": "enabled",
      "cis_reference": "https://www.cisecurity.org/benchmark/ubuntu_linux",
      "cis_control_id": "4.3.9",
      "reference_note": "For detailed description, rationale, impact assessment, and remediation steps, please refer to the official CIS Ubuntu Linux 22.04 Benchmark document at the above URL."
    },
    {
      "id": "4.3.10",
      "title": "Ensure nftables rules are permanent",
      "profile": "Level1",
      "type": "Manual",
      "cis_reference": "https://www.cisecurity.org/benchmark/ubuntu_linux",
      "cis_control_id": "4.3.10",
      "reference_note": "For detailed description, rationale, impact assessment, and remediation steps, please refer to the official CIS Ubuntu Linux 22.04 Benchmark document at the above URL."
    }
  ]
}